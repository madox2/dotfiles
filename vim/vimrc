"============= PLUGINS =============
call plug#begin('~/.vim/plugged')
Plug 'bronson/vim-trailing-whitespace' "remove trailing whitespaces
Plug 'scrooloose/nerdtree'
Plug 'vim-scripts/vim-nerdtree_plugin_open' "open files by default app
Plug 'pangloss/vim-javascript' "javascript syntax
Plug 'maxmellon/vim-jsx-pretty'
Plug 'alvan/vim-closetag' "auto close xml tag
Plug 'jiangmiao/auto-pairs' "auto brackets, quotes, ...
Plug 'mileszs/ack.vim' "find in files
Plug 'kshenoy/vim-signature' "show marks
Plug 'bling/vim-airline' "theme
Plug 'Valloric/YouCompleteMe', { 'dir': '~/.vim/plugged/YouCompleteMe', 'do': './install.sh' } "auto completion support
Plug 'tpope/vim-fugitive' "git plugin
Plug 'rbong/vim-flog' "git log as tree
Plug 'elzr/vim-json' "json highlighting, no-js warnings
Plug 'tpope/vim-surround' "change brackets, quotes quickly
Plug 'scrooloose/nerdcommenter' "comment utility
Plug 'tpope/vim-repeat' "improved dot command
Plug 'tpope/vim-unimpaired' "moving through lists
Plug 'Galooshi/vim-import-js' "import utility for js: npm install -g import-js
Plug 'christoomey/vim-tmux-navigator' "seamles tmux-vim navigation ctrl+hjkl
Plug 'godlygeek/tabular' "tabular indentation utils
Plug 'w0rp/ale' "linting, auto fixing engine
Plug 'airblade/vim-gitgutter'
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' }
Plug 'junegunn/fzf.vim'
Plug 'leafgarland/typescript-vim' "typescript code highlighting
Plug 'ianks/vim-tsx' "support jsx in tsx
Plug 'Xuyuanp/nerdtree-git-plugin'
Plug 'styled-components/vim-styled-components', { 'branch': 'main' }
Plug 'jparise/vim-graphql' "syntax highlighting for graphql
call plug#end()

"============= NOTES =============
"JS/TS autocompletion
" - install typescript (npm i -g typescript)
" - https://github.com/Valloric/YouCompleteMe#javascript-and-typescript-semantic-completion

"============= PREFERENCES =============
set clipboard^=unnamed,unnamedplus
set hls
set incsearch
set autoindent
set tabstop=2
set shiftwidth=2
set expandtab
set nu
set swapfile
set backupcopy=yes
set dir=~/tmp
set shortmess+=A
set hidden
set autoread
set diffopt+=vertical " see diffs in vertical split panes (fugitive)

filetype plugin indent on
syntax enable
let g:nerdtree_plugin_open_cmd = 'xdg-open'
let g:javascript_plugin_jsdoc = 1
let g:closetag_filenames = "*.html,*.xhtml,*.phtml,*.js,*.jsx,*.tsx,*.php"
let g:fzf_history_dir = '~/.local/share/fzf-history'
let g:ycm_autoclose_preview_window_after_insertion = 1
let g:ycm_auto_hover='' " disable auto hover YCMHover
set completeopt-=preview "ycm: disable preview in hsplit
let NERDTreeAutoDeleteBuffer = 1
let g:vim_jsx_pretty_colorful_config = 1
autocmd BufNewFile,BufRead *.md set syntax=markdown
autocmd BufNewFile,BufRead .prettierrc set syntax=json
autocmd BufNewFile,BufRead .eslintrc set syntax=json
" close vim if the only window left open
autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif
" don't search filenames with Ag command
command! -bang -nargs=* Ag call fzf#vim#ag(<q-args>, fzf#vim#with_preview({'options': '--delimiter : --nth 4..'}, 'up:40%'), <bang>0)
" search knowladge base with preview
command! -bang -nargs=* KB call fzf#vim#ag(<q-args>, fzf#vim#with_preview({'dir': '~/Dropbox/DEV/kb/'}, 'up:40%'), <bang>0)
" customized files with preview window
command! -bang -nargs=* FilesCustom call fzf#vim#files(<q-args>, fzf#vim#with_preview('up:40%'), <bang>0)
" disable timeout when pressing esc in fzf window
autocmd! FileType fzf tnoremap <buffer> <esc> <c-c>
" prevent clearing clipboard after closing (https://stackoverflow.com/a/9381778/741871)
autocmd VimLeave * call system("xsel -ib", getreg('+'))

"============= BINDINGS =============
nmap <Enter> :NERDTreeFind<CR>
nmap <F5> :w<CR>:!node %<CR>
nmap <Space> :Buffers<CR>
nmap <C-@> :Ag<CR>
nmap <C-N> :BLines<CR>
"fix `enter` in quickfix list
autocmd BufReadPost quickfix nnoremap <buffer> <CR> <CR>

"imporved default fzf command to exclude ignore files
"https://github.com/junegunn/fzf.vim/issues/121
let $FZF_DEFAULT_COMMAND = 'ag --hidden -g ""'
nmap <C-p> <Esc>:FilesCustom<CR>

" knowladge base shortcut
nnoremap <leader>kb :KB<CR>

"============= THEME =============
" Use terminal themes from https://github.com/Mayccoll/Gogh
highlight colorcolumn ctermbg=0
set colorcolumn=80
set t_Co=256
set background=dark

"============= LINTING =============
let g:airline#extensions#ale#enabled = 1
let g:ale_sign_column_always = 1
let g:ale_fix_on_save = 1
let g:ale_linters = {}
let g:ale_linters['javascript'] = ['eslint']
let g:ale_linters['typescript'] = ['tslint', 'tsserver', 'eslint']
let g:ale_fixers = {}
let g:ale_fixers['javascript'] = ['prettier', 'eslint']
let g:ale_fixers['typescript'] = ['prettier']
let g:ale_fixers['scss'] = ['prettier']
let g:ale_fixers['css'] = ['prettier']
let g:ale_fixers['less'] = ['prettier']
let g:ale_fixers['json'] = ['prettier']
let g:ale_fixers['yaml'] = ['prettier']
let g:ale_javascript_prettier_use_local_config = 1

" use eslint_d to speed up linting (requires global eslint_d to be installed)
let g:ale_javascript_eslint_use_global = 1
let g:ale_javascript_eslint_executable = 'eslint_d'


"============= DIAGNOSTIC/COMPLETER =============
" tyypescript/javascript mappings
nnoremap <leader>gg :YcmCompleter GoTo<CR>
nnoremap <leader>gd :YcmCompleter GoToDefinition<CR>
nnoremap <leader>gt :YcmCompleter GoToType<CR>
nnoremap <leader>gr :YcmCompleter GoToReferences<CR>
nnoremap <leader>f :YcmCompleter FixIt<CR>
"nnoremap <leader>t :YcmCompleter GetType<CR>
nmap <leader>t <plug>(YCMHover)

"============= WORKAROUNDS =============

" hide diagnostic symbols in YCM (errors will be highlighted with ale)
" https://github.com/Valloric/YouCompleteMe/issues/1192#issuecomment-56555948
let g:ycm_show_diagnostics_ui = 1
let g:ycm_enable_diagnostic_signs = 0
let g:ycm_enable_diagnostic_highlighting = 0

" Allow to open files in quicklist in fzf
" https://github.com/junegunn/fzf/blob/master/README-VIM.md#examples
function! s:build_quickfix_list(lines)
  call setqflist(map(copy(a:lines), '{ "filename": v:val }'))
  copen
  cc
endfunction
let g:fzf_action = {
  \ 'ctrl-q': function('s:build_quickfix_list'),
  \ 'ctrl-t': 'tab split',
  \ 'ctrl-x': 'split',
  \ 'ctrl-v': 'vsplit' }

" Proper closetag regions for typescript
let g:closetag_regions =  {
\ 'typescript.tsx': 'jsxRegion,tsxRegion',
\ 'javascript.jsx': 'jsxRegion',
\ }

" To enable javascript completer in JSX files (YCM)
" https://github.com/ycm-core/YouCompleteMe/issues/1841#issuecomment-165025815
autocmd BufEnter *.jsx set filetype=javascript
